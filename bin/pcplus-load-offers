#!/usr/bin/env python

import re
import time
import argparse

from selenium import webdriver
from selenium.common import exceptions


SIGNIN_URL = 'https://www.pcplus.ca/'

SIGNIN_FORM = '/html/body/div[1]/div/div/header/div[3]/a[1]'
SIGNIN_EMAIL = '//*[@id="signinEmail"]'
SIGNIN_PASSWORD = '//*[@id="signinPassword"]'
SIGNIN_BUTTON = '//*[@id="headerSigninForm"]/fieldset/button'

OFFERS_URL = 'https://www.pcplus.ca/loyaltyOffers.jsp'
OFFERS_BUTTON = '//*[@id="overlayOfferPromptToLoadForm"]/fieldset/p[2]/input'

SIGNOUT_BUTTON = '/html/body/div[1]/div/div/header/div[3]/a'

POINTS_RE = re.compile(r'you have\s+(?P<points>[0-9,]+)\s+points', re.MULTILINE)


def load_offers(driver, timeout, email, password):
    driver.set_window_size(1120, 550)
    driver.implicitly_wait(timeout)

    driver.get(SIGNIN_URL)
    driver.find_element_by_xpath(SIGNIN_FORM).click()
    driver.find_element_by_xpath(SIGNIN_EMAIL).send_keys(email)
    driver.find_element_by_xpath(SIGNIN_PASSWORD).send_keys(password)
    driver.find_element_by_xpath(SIGNIN_BUTTON).click()

    driver.get(OFFERS_URL)
    time.sleep(timeout)
    match = POINTS_RE.search(driver.page_source)
    points = int(match.groups('points')[0].replace(',', ''))
    try:
        iframe = driver.find_element_by_tag_name('iframe')
    except exceptions.NoSuchElementException:
        pass # No offers to load.
    else:
        driver.switch_to.frame(iframe)
        driver.find_element_by_xpath(OFFERS_BUTTON).click()
        driver.switch_to.default_content()
    finally:
        driver.find_element_by_xpath(SIGNOUT_BUTTON).click()
        driver.quit()


def main():
    parser = argparse.ArgumentParser(
        description='Sign in into pcplus.ca and load all the offers.')
    driver = parser.add_mutually_exclusive_group(required=True)
    driver.add_argument('--firefox', action='store_true',
                        help='use the Firefox web driver')
    driver.add_argument('--phantomjs', action='store_true',
                        help='use the PhantomJS web driver')
    parser.add_argument('--email', required=True,
                        help='pcplus.ca email address')
    parser.add_argument('--password', required=True,
                        help='pcplus.ca password')
    parser.add_argument('--timeout', type=int, default=10, metavar='SECONDS',
                        help='timeout for web requests (default: %(default)s)')

    args = parser.parse_args()
    if args.firefox:
        driver = webdriver.Firefox()
    elif args.phantomjs:
        service_args = ['--ssl-protocol=any', '--ignore-ssl-errors=true']
        driver = webdriver.PhantomJS(service_args=service_args)
    load_offers(driver, args.timeout, args.email, args.password)


if __name__ == '__main__':
    main()
